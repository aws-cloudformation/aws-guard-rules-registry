###
# CMK_BACKING_KEY_ROTATION_ENABLED tests
###
- name: EnableKeyRotation is set to true, PASS
  input:
    Resources:
      myKMSKey:
        Type: AWS::KMS::Key
        Properties:
          EnableKeyRotation: true
          KeyPolicy:
            Statement:
              - Action: kms:*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
            Version: "2012-10-17"
  expectations:
    rules:
      CMK_BACKING_KEY_ROTATION_ENABLED: PASS

- name: EnableKeyRotation does not exist, FAIL
  input:
    Resources:
      myKMSKey:
        Type: AWS::KMS::Key
        Properties:
          KeyPolicy:
            Statement:
              - Action: kms:*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
            Version: "2012-10-17"
  expectations:
    rules:
      CMK_BACKING_KEY_ROTATION_ENABLED: FAIL

- name: EnableKeyRotation is set to false, FAIL
  input:
    Resources:
      myKMSKey:
        Type: AWS::KMS::Key
        Properties:
          EnableKeyRotation: false
          KeyPolicy:
            Statement:
              - Action: kms:*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
            Version: "2012-10-17"
  expectations:
    rules:
      CMK_BACKING_KEY_ROTATION_ENABLED: FAIL


- name: failed rule that has the rule suppressed, SKIP
  input:
    Resources:
      myKMSKey:
        Type: AWS::KMS::Key
        Metadata:
          guard:
            SuppressedRules:
              - "CMK_BACKING_KEY_ROTATION_ENABLED"
        Properties:
          EnableKeyRotation: false
          KeyPolicy:
            Statement:
              - Action: kms:*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                Effect: Allow
                Principal:
                  AWS:
                    Fn::Join:
                      - ""
                      - - 'arn:'
                        - Ref: AWS::Partition
                        - :iam::123456789012:root
                Resource: '*'
            Version: "2012-10-17"
  expectations:
    rules:
      CMK_BACKING_KEY_ROTATION_ENABLED: SKIP